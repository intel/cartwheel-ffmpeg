From f03b54f460a00789ce8d6ca8d2693e9609c6f431 Mon Sep 17 00:00:00 2001
From: "Galin, Artem" <artem.galin@intel.com>
Date: Tue, 20 Jul 2021 12:01:48 +0800
Subject: [PATCH 78/92] hwcontext_qsv: create session for D3D11 implemetation

The mfxImplDescription.AccelerationMode must be MFX_ACCEL_MODE_VIA_D3D11
for D3D11 implementation

Signed-off-by: Haihao Xiang <haihao.xiang@intel.com>
---
 libavutil/hwcontext_qsv.c | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/libavutil/hwcontext_qsv.c b/libavutil/hwcontext_qsv.c
index d3c061b739..fed20ae5e9 100644
--- a/libavutil/hwcontext_qsv.c
+++ b/libavutil/hwcontext_qsv.c
@@ -582,7 +582,8 @@ static int qsv_create_mfx_session(void *ctx,
            MFX_VERSION_MAJOR, MFX_VERSION_MINOR, pver->Major, pver->Minor);
 
     if (handle_type != MFX_HANDLE_VA_DISPLAY &&
-        handle_type != MFX_HANDLE_D3D9_DEVICE_MANAGER) {
+        handle_type != MFX_HANDLE_D3D9_DEVICE_MANAGER &&
+        handle_type != MFX_HANDLE_D3D11_DEVICE) {
         av_log(ctx, AV_LOG_ERROR,
                "Invalid MFX device handle\n");
         return AVERROR(EXDEV);
@@ -621,8 +622,10 @@ static int qsv_create_mfx_session(void *ctx,
 
     if (MFX_HANDLE_VA_DISPLAY == handle_type)
         impl_value.Data.U32 = MFX_ACCEL_MODE_VIA_VAAPI;
-    else
+    else if (MFX_HANDLE_D3D9_DEVICE_MANAGER == handle_type)
         impl_value.Data.U32 = MFX_ACCEL_MODE_VIA_D3D9;
+    else
+        impl_value.Data.U32 = MFX_ACCEL_MODE_VIA_D3D11;
 
     sts = MFXSetConfigFilterProperty(cfg,
                                      (const mfxU8 *)"mfxImplDescription.AccelerationMode", impl_value);
-- 
2.17.1

