From 0f3c6d0af67693b24e1fe7f6fba96f0af4d3c994 Mon Sep 17 00:00:00 2001
From: Fei Wang <fei.w.wang@intel.com>
Date: Mon, 2 Nov 2020 10:45:29 +0800
Subject: [PATCH 11/88] fftools/ffmpeg: support variable resolution encode

Flush encoders when resolution change happens.

Use AV_CODEC_CAP_PARAM_CHANGE flag for encoder to indicate whether
it supports variable/dynamic resolution encoding.

Signed-off-by: Linjie Fu <linjie.fu@intel.com>
---
 fftools/ffmpeg.c    | 14 ++++++++++++++
 libavcodec/rawenc.c |  4 +++-
 2 files changed, 17 insertions(+), 1 deletion(-)

diff --git a/fftools/ffmpeg.c b/fftools/ffmpeg.c
index bdeff9a12e..b7e30fe878 100644
--- a/fftools/ffmpeg.c
+++ b/fftools/ffmpeg.c
@@ -130,6 +130,7 @@ static void do_video_stats(OutputStream *ost, int frame_size);
 static BenchmarkTimeStamps get_benchmark_time_stamps(void);
 static int64_t getmaxrss(void);
 static int ifilter_has_all_input_formats(FilterGraph *fg);
+static void flush_encoders(void);
 
 static int run_as_daemon  = 0;
 static int nb_frames_dup = 0;
@@ -1158,6 +1159,19 @@ static void do_video_out(OutputFile *of,
     init_output_stream_wrapper(ost, next_picture, 1);
     sync_ipts = adjust_frame_pts_to_encoder_tb(of, ost, next_picture);
 
+    /* flush encoders in dynamic resolution encode */
+    if (next_picture && (enc->width != next_picture->width ||
+                         enc->height != next_picture->height)) {
+        flush_encoders();
+        avcodec_flush_buffers(enc);
+
+        if (!(enc->codec->capabilities & AV_CODEC_CAP_PARAM_CHANGE)) {
+            av_log(NULL, AV_LOG_ERROR, "Dynamic resolution encode "
+                            "is not supported by %s.\n", enc->codec->name);
+            goto error;
+        }
+    }
+
     if (ost->source_index >= 0)
         ist = input_streams[ost->source_index];
 
diff --git a/libavcodec/rawenc.c b/libavcodec/rawenc.c
index 561d992a46..3f4f09e01d 100644
--- a/libavcodec/rawenc.c
+++ b/libavcodec/rawenc.c
@@ -85,7 +85,9 @@ const AVCodec ff_rawvideo_encoder = {
     .long_name      = NULL_IF_CONFIG_SMALL("raw video"),
     .type           = AVMEDIA_TYPE_VIDEO,
     .id             = AV_CODEC_ID_RAWVIDEO,
-    .capabilities   = AV_CODEC_CAP_DR1 | AV_CODEC_CAP_FRAME_THREADS,
+    /* FIXME: can't flush an encoder when AV_CODEC_CAP_FRAME_THREADS is set, so remove
+       AV_CODEC_CAP_ENCODER_FLUSH temporarily */
+    .capabilities   = AV_CODEC_CAP_DR1 | AV_CODEC_CAP_FRAME_THREADS | AV_CODEC_CAP_PARAM_CHANGE,
     .init           = raw_encode_init,
     .encode2        = raw_encode,
     .caps_internal  = FF_CODEC_CAP_INIT_THREADSAFE,
-- 
2.17.1

